<html>
<head>
    <meta charset="utf-8">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.12.4/brython.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.12.4/brython_stdlib.js"></script>
</head>
<body onload="brython({debug: 1, cache: true})">
<!-- input text -->
<input type="text" id="input" value="Hello, world!">
<script type="text/python">

import io
import gzip
import collections

import pyflate.log
from browser import document
from browser.html import BR, SPAN as S


log_messages = collections.defaultdict(list)


def log_to_html(s):
    document['output'] <= s


def log_noop(s):
    pass


def log(*args) -> None:
    """Log the arguments at the debug level."""
    offset = bit.tellbits()
    s = (" ".join(map(str, args)))
    log_messages[offset].append(s)
    log_to_html(f'[{offset}] {s}\n')

pyflate.log = log
import pyflate

def print_hexdump(data: bytes) -> None:
    """Print a hexdump of the buffer."""
    hd = document['hexdump']
    bit_number = 0
    for i in range(0, len(data), 4):
        b = data[i:i+4]
        # print hex
        hd <= S(f'{i:08x}  ')
        for c in b:
            hd <= S(f'{c:02x} ')
        # align hex
        for j in range(4 - len(b)):
            hd <= S('   ')
        hd <= S(' [')
        # print binary
        for c in b:
            hd <= S(f'{c:08b} ')
            bit_number += 1
        # align binary
        for j in range(4 - len(b)):
            hd <= S('         ')
        hd <= S('] ')
        # print ASCII
        for c in b:
            # should we use a dot for non-hd <= Sable characters?
            if c < 32 or c > 126:
                hd <= S('.')
            else:
                hd <= S(chr(c))
        hd <= BR()


def run_program(*args):
    global bit, log_to_html, log_messages
    document['output'].text = '' # Clear previous output
    s = document['input'].value
    log_to_html_copy = log_to_html
    log_messages = collections.defaultdict(list)
    try:
        buf = gzip.compress(s.encode())

        # we do a dry run first to get the log messages for hexdump
        log_to_html = log_noop
        inp = io.BytesIO(buf)
        bit = pyflate.Bitfield(inp)
        out = pyflate.gzip_main_bitfield(bit)

        log_to_html = log_to_html_copy
        inp = io.BytesIO(buf)
        bit = pyflate.Bitfield(inp)
        print_hexdump(buf)
        out = pyflate.gzip_main_bitfield(bit)
        document['decompressed_data'].text = out.decode('utf-8')
    except Exception as e:
        log(f"Error: {e}")
        import traceback
        log(traceback.format_exc())

# Initial run
run_program()

# Add event listener for input change
document['input'].bind('input', run_program)

</script>
<pre id="hexdump"></pre>
<pre id="output">Loading a demo of pyflate2. This will take a few seconds...

</pre>

Decompressed data: <span id="decompressed_data"></span>

<p>
    Code that's running this demo can be found at:

    <a href="https://github.com/d33mobile/pyflate2/">
    https://github.com/d33mobile/pyflate2/
    </a>
</p>

</body>
</html>
